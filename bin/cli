#!/usr/bin/env node
const fs = require('fs')
const path = require('path')
const program = require('commander');
const chalk = require('chalk');
const shell = require('shelljs');

const pkg = require('../package');
const { getSpace, getScripts, getDependencies, getDevDependencies } = require('../utils')

const res = command => path.resolve(__dirname, '../commands/', command);

program.version(chalk.green(`${pkg.version}`))

program
    .command('all')
    .description('é¡¹ç›®æ·»åŠ husky/eslinté…ç½®')
    .alias('a')
    .action(() => {
        require(res('all'))();
    })


program
    .command('husky')
    .description('é¡¹ç›®æ·»åŠ huskyé…ç½®')
    .alias('h')
    .action(() => {
        require(res('husky'))();
    })

program
    .command('eslint')
    .description('é¡¹ç›®æ·»åŠ eslinté…ç½®')
    .alias('e')
    .action(() => {
        require(res('eslint'))();
    })


program
.action(async() => {
    spinner.start("ğŸš€ tdhusky åˆå§‹åŒ–ä¸­");
    const str = fs.readFileSync(path.resolve(process.cwd(), 'package.json'), 'utf-8');
    const packageJSON = JSON.parse(str)

    packageJSON.scripts = getScripts(packageJSON.scripts)
    if(packageJSON.dependencies) {
        packageJSON.dependencies = getDependencies(packageJSON.dependencies)
    }
    if(packageJSON.devDependencies) {
        packageJSON.devDependencies = await getDevDependencies(packageJSON.devDependencies)
    }
    packageJSON["config"] = {
        "commitizen": {
            "path": "./node_modules/cz-customizable"
        }
    }
    packageJSON["lint-staged"] = {
        "src/**/*.{js,jsx,ts,tsx}": [
            "eslint --max-warnings 0 --ext .js,.jsx,.ts,.tsx"
        ]
    }
    // é‡å†™package.json
    fs.writeFileSync(path.resolve(process.cwd(), './package.json'), JSON.stringify(packageJSON, null, 4))

    // copy templateeé‡Œé¢çš„æ–‡ä»¶
    await shell.cp(path.resolve(__dirname, '../template/commitlint.config.js'), process.cwd())
    await shell.cp(path.resolve(__dirname, '../template/.cz-config.js'), process.cwd())
    await shell.cp(path.resolve(__dirname, '../template/.eslintrc'), process.cwd())
    await shell.cp(path.resolve(__dirname, '../template/.editorconfig'), process.cwd())

    await shell.cd(process.cwd())

    // å®‰è£…eslintéœ€è¦åˆ é™¤node_modules å’Œ package-lock.json
    await shell.rm('-rf', 'package-lock.json')
    await shell.rm('-rf', 'node_modules')
    await shell.exec('npm i')

    // æ‰§è¡Œgit hook
    await shell.exec('npm run prepare')
    await shell.exec(`npx husky add .husky/commit-msg 'npx commitlint --edit'`)
    await shell.exec(`npx husky add .husky/pre-commit 'echo "å¼€å§‹å¯¹ä¿®æ”¹æ–‡ä»¶è¿›è¡Œeslintæ ¡éªŒ'"`)
    await shell.exec(`npx husky add .husky/pre-commit 'npx --no-install lint-staged'`)
    await shell.exec(`npx husky add .husky/prepare-commit-msg 'exec < /dev/tty && node_modules/.bin/cz --hook || true'`)
    spinner.succeed("ğŸ˜„ åˆå§‹åŒ–å®Œæˆ, ğŸ¤–ï¸ç”Ÿæˆè„šæœ¬");
});

program.parse(process.argv)
